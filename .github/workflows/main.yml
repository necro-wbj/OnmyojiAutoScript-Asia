# .github/workflows/auto-sync-upstream-dev.yml
name: Auto Rebase Upstream Dev

on:
  schedule:
    - cron: "*/15 * * * *"     # â± æ¯ 15 åˆ†é˜è§¸ç™¼ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰
  workflow_dispatch: {}         # ğŸ– æ‰‹å‹•è§¸ç™¼
  push:
    branches: [ main ]
    paths-ignore:
      - ".github/**"
      - "docs/**"
      - "README.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write               # å…è¨±æ¨åˆ†æ”¯
  pull-requests: write          # å…è¨±å»ºç«‹/æ›´æ–° PR

jobs:
  sync-upstream:
    if: github.actor != 'github-actions[bot]'  # é¿å…æ©Ÿå™¨äººäº’ç›¸è§¸ç™¼
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1) å–å‡ºå®Œæ•´æ­·å²ï¼Œåˆä½µ/è®ŠåŸºæ‰ä¸æœƒç¼ºå…±åŒç¥–å…ˆ
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) è¨­å®š Git èº«åˆ†
      - name: Setup Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 3) æ–°å¢ upstream ä¸¦æŠ“å–
      - name: Add upstream and fetch
        run: |
          set -e
          git remote add upstream https://github.com/runhey/OnmyojiAutoScript.git || true
          git fetch --prune upstream
          git fetch --prune origin

      # 4) æ²’æœ‰è®Šæ›´å°±æå‰çµæŸï¼ˆä¸ç™¼é€šçŸ¥ï¼‰
      - name: Exit early if no changes from upstream
        id: earlycheck
        run: |
          set -e
          if git rev-parse --verify upstream/dev >/dev/null 2>&1; then
            if git diff --quiet origin/main..upstream/dev; then
              echo "no_changes=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "no_changes=false" >> $GITHUB_OUTPUT

      # 5) æœ‰è®Šæ›´æ‰å˜—è©¦åˆä½µï¼ˆå…ˆ fast-forwardï¼Œå¤±æ•—å†ä¸€èˆ¬ mergeï¼‰
      - name: Prepare update branch and merge
        if: steps.earlycheck.outputs.no_changes != 'true'
        id: merge
        env:
          PR_BRANCH: auto-rebase/upstream-dev
        run: |
          set -e
          git checkout -B "$PR_BRANCH" origin/main

          if git merge --ff-only upstream/dev; then
            echo "result=merged" >> $GITHUB_OUTPUT
            echo "detail=fast-forward" >> $GITHUB_OUTPUT
            exit 0
          fi

          set +e
          git merge --no-edit upstream/dev
          code=$?
          set -e

          if [ $code -eq 0 ]; then
            echo "result=merged" >> $GITHUB_OUTPUT
            echo "detail=merge-commit" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
            echo "detail=merge-conflict-or-error" >> $GITHUB_OUTPUT
          fi

      # 6) åˆä½µæˆåŠŸæ‰å»ºç«‹/æ›´æ–° PR
      - name: Create / Update PR
        if: steps.merge.outputs.result == 'merged'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto-rebase/upstream-dev
          title: "Auto sync upstream/dev â†’ main"
          body: "Automated sync from upstream/dev."
          labels: "chore,auto-sync"
          delete-branch: false
          base: main

      # 7) Discordï¼šæˆåŠŸå»ºç«‹/æ›´æ–° PRï¼ˆåªåœ¨æœ‰è®Šæ›´ä¸”æˆåŠŸæ™‚ç™¼ï¼‰
      - name: Notify Discord (PR created/updated)
        if: steps.merge.outputs.result == 'merged' && steps.cpr.outputs.pull-request-number != '' && steps.cpr.outputs.pull-request-operation != 'none'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          PR_NUM: ${{ steps.cpr.outputs.pull-request-number }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          OP: ${{ steps.cpr.outputs.pull-request-operation }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -e
          PR_PATH="${REPO}/pull/${PR_NUM}"
          SUMMARY=$(cat <<EOF
          ğŸ”„ **Auto sync upstream/dev â†’ main** (${OP})
          Repo: ${REPO}
          PR: ${PR_URL}
          PR Path: ${PR_PATH}
          Run: ${RUN_URL}
          EOF
          )
                    curl -sS -X POST "$DISCORD_WEBHOOK" \
                      -H 'Content-Type: application/json' \
                      -d "$(jq -n --arg content "$SUMMARY" '{content: $content}')"
          
                # 8) Discordï¼šåˆä½µå¤±æ•—ï¼ˆæœ‰è®Šæ›´ä½†å¤±æ•—æ™‚ç™¼ï¼‰ï¼Œä¸¦è®“ job å¤±æ•—
                - name: Notify Discord (merge failed)
                  if: steps.merge.outputs.result == 'failed'
                  env:
                    DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
                    REPO: ${{ github.repository }}
                    DETAIL: ${{ steps.merge.outputs.detail }}
                    RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
                  run: |
                    set -e
                    MSG=$(cat <<EOF
          âŒ **Auto sync upstream/dev â†’ main failed (merge)**
          Repo: ${REPO}
          Reason: ${DETAIL}
          Run: ${RUN_URL}
          Hint: Resolve conflicts locally, then push a fix or re-run the workflow.
          EOF
          )
                    curl -sS -X POST "$DISCORD_WEBHOOK" \
                      -H 'Content-Type: application/json' \
                      -d "$(jq -n --arg content "$MSG" '{content: $content}')"
          
                - name: Fail job if merge failed
                  if: steps.merge.outputs.result == 'failed'
                  run: |
                    echo "Merge failed, marking job as failed."
                    exit 1
