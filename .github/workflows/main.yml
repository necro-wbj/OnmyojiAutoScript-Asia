name: Auto Rebase Upstream Dev

on:
  schedule:
    - cron: "*/5 * * * *"      # æ¯ 5 åˆ†é˜è§¸ç™¼ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰
  workflow_dispatch: {}         # æ‰‹å‹•è§¸ç™¼
  push:
    branches: [ main ]
    paths-ignore:
      - ".github/**"
      - "docs/**"
      - "README.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream:
    if: github.event_name != 'pull_request'   # é¿å… PR äº‹ä»¶éè¿´
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # è®“æˆ‘å€‘å®Œå…¨æ§åˆ¶èªè­‰æ–¹å¼ï¼›ä½†é€™è£¡ç”¨ CPR å¹«æ¨ï¼Œå°±ç®—ä¿ç•™é è¨­ä¹Ÿ OK
          persist-credentials: true

      - name: Setup Git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          set -e
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/runhey/OnmyojiAutoScript.git
          git fetch --prune origin
          git fetch --prune upstream

      # è§£æè¦åŒæ­¥çš„ä¾†æºï¼šå„ªå…ˆ upstream/devï¼›è‹¥ä¸å­˜åœ¨ï¼Œfallback åˆ°è‡ªå·±çš„ origin/main
      - name: Resolve upstream ref (dev or origin/main)
        id: resolve
        shell: bash
        run: |
          set -e
          TARGET_BRANCH="dev"
          if git ls-remote --heads upstream "$TARGET_BRANCH" | grep -q "refs/heads/$TARGET_BRANCH"; then
            UP_REF="upstream/${TARGET_BRANCH}"
            REASON="found-branch"
          else
            UP_REF="origin/main"
            REASON="fallback-origin-main"
          fi

          git fetch --prune origin
          if [[ "$UP_REF" == upstream/* ]]; then git fetch --prune upstream; fi

          UP_TIP=$(git rev-parse --short "${UP_REF}")
          ORI_TIP=$(git rev-parse --short origin/main)
          read BEHIND AHEAD < <(git rev-list --left-right --count origin/main..."${UP_REF}" | awk '{print $1" "$2}')

          echo "up_ref=${UP_REF}"           >> $GITHUB_OUTPUT
          echo "reason=${REASON}"           >> $GITHUB_OUTPUT
          echo "upstream_tip=${UP_TIP}"     >> $GITHUB_OUTPUT
          echo "origin_tip=${ORI_TIP}"      >> $GITHUB_OUTPUT
          echo "ahead=${AHEAD}"             >> $GITHUB_OUTPUT
          echo "behind=${BEHIND}"           >> $GITHUB_OUTPUT

          echo "[LOG] Using upstream ref: ${UP_REF} (${REASON})"
          echo "[LOG] origin/main tip:  ${ORI_TIP}"
          echo "[LOG] ${UP_REF} tip:     ${UP_TIP}"
          echo "[LOG] AHEAD=${AHEAD}, BEHIND=${BEHIND}"

      - name: Exit early if no changes from upstream
        id: earlycheck
        shell: bash
        run: |
          set -e
          UP_REF="${{ steps.resolve.outputs.up_ref }}"
          if git diff --quiet origin/main.."${UP_REF}"; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "[LOG] No changes detected between origin/main and ${UP_REF}. Exit for PR creation."
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
            echo "[LOG] Changes detected from ${UP_REF}. PR will be created/updated."
          fi

      # â­ é‡è¦ï¼šä¸è‡ªå·± pushã€‚
      # æˆ‘å€‘ä»¥ origin/main ç‚ºåŸºåº•ï¼ŒæŠŠå·¥ä½œæ¨¹ã€Œé‚„åŸã€æˆ UP_REF çš„æª”æ¡ˆç‹€æ…‹ä¸¦æš«å­˜ï¼Œ
      # è®“ CPR ç›´æ¥å¹«æˆ‘å€‘å»ºç«‹/æ›´æ–°åˆ†æ”¯èˆ‡ PRã€‚
      - name: Materialize upstream ref into working tree (no commit)
        if: steps.earlycheck.outputs.no_changes != 'true'
        shell: bash
        run: |
          set -e
          UP_REF="${{ steps.resolve.outputs.up_ref }}"
          # å…ˆå¾ base èµ°ï¼ˆä¿ç•™åˆç†çš„çˆ¶æäº¤ï¼‰ï¼Œå†æŠŠå…§å®¹ã€Œè¦†å¯«æˆã€UP_REF çš„æ¨¹ç‹€
          git checkout -B base-for-sync origin/main
          # å°‡ UP_REF çš„å…§å®¹ã€Œrestoreã€åˆ°å·¥ä½œå€èˆ‡ç´¢å¼•ï¼ˆç­‰åŒå…¨é‡è¦†å¯«ï¼‰
          git restore --source="${UP_REF}" --worktree --staged :/
          # é¡¯ç¤ºå·®ç•°çµ±è¨ˆ
          echo "[LOG] Staged diff against origin/main:"
          git diff --cached --stat || true

      - name: Create / Update PR
        if: steps.earlycheck.outputs.no_changes != 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          # CPR æœƒæŠŠã€Œç›®å‰å·¥ä½œæ¨¹èˆ‡ç´¢å¼•çš„æ”¹å‹•ã€æäº¤åˆ°é€™å€‹åˆ†æ”¯ï¼Œä¸¦é–‹/æ›´æ–° PR
          branch: sync/upstream-dev
          base: main
          title: >-
            Auto sync ${{ steps.resolve.outputs.up_ref }} â†’ main
          commit-message: >-
            chore(sync): mirror ${{ steps.resolve.outputs.up_ref }} into main
          body: |
            Automated sync from **${{ steps.resolve.outputs.up_ref }}** to **main**.

            - upstream ref: `${{ steps.resolve.outputs.up_ref }}`
            - reason: `${{ steps.resolve.outputs.reason }}`  (found-branch / fallback-origin-main)
            - upstream tip: `${{ steps.resolve.outputs.upstream_tip }}`
            - origin tip:   `${{ steps.resolve.outputs.origin_tip }}`
            - ahead:  `${{ steps.resolve.outputs.ahead }}`
            - behind: `${{ steps.resolve.outputs.behind }}`

            This PR is generated by creating a tree identical to the upstream ref on top of `origin/main` (no manual push).
          labels: "chore,auto-sync"
          delete-branch: false

      # âœ… æœ‰ PRï¼šè²¼ PR é€£çµ
      - name: Notify Discord (PR created/updated)
        if: steps.earlycheck.outputs.no_changes != 'true' && steps.cpr.outputs.pull-request-operation != 'none'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          OP: ${{ steps.cpr.outputs.pull-request-operation }}
        run: |
          set -e
          MSG=$(cat <<EOF
          ğŸ”„ **Auto sync ${{ steps.resolve.outputs.up_ref }} â†’ main** (${OP})
          PR: ${PR_URL}
          EOF
          )
          curl -sS -X POST "$DISCORD_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg content "$MSG" '{content: $content}')"

      # âŒ ä»»ä¸€æ­¥é©Ÿå¤±æ•—ï¼šè²¼ Action Run é€£çµ
      - name: Notify Discord (run failed)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -e
          MSG=$(cat <<EOF
          âŒ **Auto sync failed**
          Run: ${RUN_URL}
          EOF
          )
          curl -sS -X POST "$DISCORD_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg content "$MSG" '{content: $content}')"
