name: Auto sync from upstream/dev to main (overlay rebase)

on:
  schedule:
    - cron: "*/5 * * * *"   # 每 5 分鐘（UTC）
  workflow_dispatch: {}
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: auto-rebase-upstream-dev
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream & fetch
        run: |
          git remote add upstream https://github.com/runhey/OnmyojiAutoScript.git || true
          git fetch --all --prune

      # === 早退：若 upstream/dev tip 與上次相同，直接結束 ===
      - name: Get upstream tip
        id: tip
        run: |
          echo "sha=$(git rev-parse upstream/dev)" >> $GITHUB_OUTPUT

      - name: Restore last-processed tip
        id: last
        uses: actions/cache/restore@v4
        with:
          path: .upstream-tip
          key: upstream-tip-${{ steps.tip.outputs.sha }}

      - name: Skip if no change
        if: steps.last.outputs.cache-hit == 'true'
        run: |
          echo "Upstream dev has no new commits; exiting."
          exit 0

      # === 啟用 & 還原 rerere 快取 ===
      - name: Enable rerere (local)
        run: |
          git config rerere.enabled true
          git config rerere.autoupdate true

      - name: Restore rerere cache
        uses: actions/cache@v4
        with:
          path: .git/rr-cache
          key: rr-cache-${{ github.ref_name }}
          restore-keys: |
            rr-cache-

      # === 以 upstream/dev 為基底建立工作分支 ===
      - name: Prepare working branch from upstream/dev
        run: |
          git switch -C auto-rebase/upstream-dev upstream/dev

      # === 套用 overlay 提交（處理：正常/衝突/空補丁） ===
      - name: Cherry-pick overlay commit(s) from main
        env:
          BASE_BRANCH: main
        run: |
          COMMITS=$(git log --reverse --format=%H upstream/dev..origin/${BASE_BRANCH})

          if [ -z "$COMMITS" ]; then
            echo "NO_OVERLAY=1" >> $GITHUB_ENV
            exit 0
          fi

          set -e
          for c in $COMMITS; do
            echo "::group::Cherry-picking $c"
            if git cherry-pick -x $c; then
              echo "Applied $c"
              echo "::endgroup::"
              continue
            fi

            # 非 0：判斷是「真衝突」還是「空補丁/已套用」
            if git ls-files -u | grep -q . ; then
              echo "Detected real conflicts while applying $c"
              echo "CONFLICT=1" >> $GITHUB_ENV
              echo "::endgroup::"
              break
            else
              echo "Empty/Already-applied commit $c -> skip"
              git cherry-pick --skip || true
              echo "::endgroup::"
            fi
          done

      - name: Save rerere cache (even on conflict)
        if: always()
        uses: actions/cache@v4
        with:
          path: .git/rr-cache
          key: rr-cache-${{ github.ref_name }}

      # === 這裡可接上你的測試 ===
      - name: Run tests
        if: env.CONFLICT != '1' && env.NO_OVERLAY != '1'
        run: |
          echo "Run your tests here"
          # pytest -q || true

      # === 成功：推分支並開/更新 PR ===
      - name: Push branch & open/update PR
        if: env.CONFLICT != '1' && env.NO_OVERLAY != '1'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto-rebase/upstream-dev
          title: "chore: Rebase overlay onto latest upstream/dev"
          body: |
            自動將 `main` 的 overlay 提交套到最新 `upstream/dev`。
            - 使用 .gitattributes & rerere 降低衝突
            - 測試通過即可合併
          labels: auto-rebase
          draft: false

      # === 失敗：開 Issue 並列出衝突檔 ===
      - name: Open conflict issue
        if: env.CONFLICT == '1'
        run: |
          echo "## 自動 rebase 發生衝突，需要人工處理" > body.md
          echo "" >> body.md
          echo "**衝突檔案清單：**" >> body.md
          echo "" >> body.md
          echo '```' >> body.md
          git ls-files -u | cut -f2 | sort -u >> body.md || true
          echo '```' >> body.md
          gh issue create \
            --title "Auto rebase 衝突，請協助處理" \
            --body-file body.md \
            --label "auto-rebase" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # === Discord 通知：成功 ===
      - name: Discord notify success
        if: env.CONFLICT != '1' && env.NO_OVERLAY != '1'
        run: |
          MSG="✅ Auto rebase 成功！已建立/更新 PR：auto-rebase/upstream-dev"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\":\"$MSG\"}" \
               "https://discord.com/api/webhooks/1412622397592305814/dfHIMMiqayaA55ODa2cznyI0enNc2qhpSkG2Hvauvs3gwq0jnSL2osOQaj2kbBBXysiw"

      # === Discord 通知：衝突 ===
      - name: Discord notify conflict
        if: env.CONFLICT == '1'
        run: |
          FILES=$(git ls-files -u | cut -f2 | sort -u | tr '\n' ' ')
          MSG="⚠️ Auto rebase 衝突，需要人工處理。\n衝突檔案: $FILES"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\":\"$MSG\"}" \
               "https://discord.com/api/webhooks/1412622397592305814/dfHIMMiqayaA55ODa2cznyI0enNc2qhpSkG2Hvauvs3gwq0jnSL2osOQaj2kbBBXysiw"

      # === 標記本次處理的 upstream tip（供下次早退） ===
      - name: Save last-processed tip
        if: env.CONFLICT != '1'
        uses: actions/cache/save@v4
        with:
          path: .upstream-tip
          key: upstream-tip-${{ steps.tip.outputs.sha }}
