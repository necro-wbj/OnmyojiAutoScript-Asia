name: Auto Rebase Upstream Dev

on:
  schedule:
    - cron: "*/15 * * * *"   # â±ï¸ é™ä½æ’ç¨‹é »ç‡ï¼ˆæ¯ 15 åˆ†ï¼‰ï¼Œæ›´çœè³‡æºï¼›è¦æ›´é »ç¹è‡ªè¡Œèª¿æ•´
  workflow_dispatch: {}       # æ‰‹å‹•è§¸ç™¼
  push:
    branches: [ main ]        # åªç›£è½ mainï¼Œé¿å… PR åˆ†æ”¯ push é€ æˆé€£é–è§¸ç™¼
    paths-ignore:             # æ–‡æª”æˆ– CI è®Šæ›´ä¸è§¸ç™¼ï¼Œæ¸›å°‘ç„¡è¬‚è·‘å‹•
      - ".github/**"
      - "docs/**"
      - "README.md"

# ğŸ§  åªå…è¨±åŒä¸€åˆ†æ”¯åŒä¸€æ™‚é–“ä¸€å€‹ runï¼Œæ–°çš„ä¾†å°±å–æ¶ˆèˆŠçš„ï¼ˆå®‰éœåˆçœè³‡æºï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ğŸ” æ¬Šé™æœ€å°åŒ–ï¼šè®€ repoã€é–‹ PR
permissions:
  contents: read
  pull-requests: write

jobs:
  sync-upstream:
    # é¿å… bot çš„ push åéä¾†è§¸ç™¼è‡ªå·±ï¼ˆé˜²è‡ªæˆ‘è§¸ç™¼ï¼‰
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 20       # é™åˆ¶æœ€é•·æ™‚é–“ï¼Œé˜²å¡ä½æµªè²» runner
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1      # âš¡ å¿«ï¼šåªæŠ“æœ€æ–° commit
          fetch-tags: false
          submodules: false
          # persist-credentials é è¨­ trueï¼Œè¶³å¤  create-pull-request ä½¿ç”¨

      - name: Setup Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # â¬‡ï¸ è«‹æŠŠ <upstream-owner>/<upstream-repo> èˆ‡ upstream åˆ†æ”¯åç¨±æ”¹æˆä½ çš„å¯¦éš›å€¼
      - name: Add upstream and fetch
        run: |
          set -e
          # ä¸­æ–‡è¨»è§£ï¼šæ–°å¢ upstream ä¾†æºï¼Œè‹¥å·²å­˜åœ¨å°±å¿½ç•¥éŒ¯èª¤
          git remote add upstream https://github.com/<upstream-owner>/<upstream-repo>.git || true
          # ä¸­æ–‡è¨»è§£ï¼šåªæŠ“ upstream çš„ç›®æ¨™åˆ†æ”¯æœ€æ–°ä¸€å€‹ commitï¼ˆçœæµé‡ã€å¿«ï¼‰
          git fetch --no-tags --depth=1 upstream dev
          # ä¸­æ–‡è¨»è§£ï¼šåŒæ­¥æŠ“ä¸€ä¸‹ origin/main æœ€æ–°ä¸€å€‹ commit
          git fetch --no-tags --depth=1 origin main

      # ğŸ’¤ æ²’æœ‰å·®ç•° â†’ ç›´æ¥æˆåŠŸçµæŸï¼ˆå®‰éœï¼‰
      - name: Exit early if no changes from upstream
        run: |
          set -e
          # ä¸­æ–‡è¨»è§£ï¼šæ¯”è¼ƒ upstream/dev èˆ‡ origin/main æ˜¯å¦æœ‰å·®ç•°
          if git diff --quiet origin/main..upstream/dev; then
            echo "No upstream changes. Exiting quietly."
            exit 0
          fi

      # ğŸ§¹ ç”¨ä¹¾æ·¨åˆ†æ”¯æ‰¿è¼‰åŒæ­¥çµæœï¼ˆé¿å…æ±¡æŸ“ mainï¼‰
      - name: Prepare update branch
        env:
          PR_BRANCH: auto-rebase/upstream-dev
        run: |
          set -e
          git checkout -B "$PR_BRANCH" origin/main
          # ä¸­æ–‡è¨»è§£ï¼šå„ªå…ˆå˜—è©¦ fast-forwardï¼ŒåŒæ­¥ä¸ä¸Šå°±ç”¨ç›´ç·šåˆä½µï¼ˆå¯ä¾ä½ æµç¨‹æ”¹æˆ rebaseï¼‰
          git merge --ff-only upstream/dev || git merge --no-edit upstream/dev

      # ğŸ“¬ é€é PR äº¤ä»˜è®Šæ›´ï¼ˆä¸ç›´æ¥ push mainï¼Œé¢¨éšªè¼ƒä½ï¼‰
      - name: Create / Update PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto-rebase/upstream-dev
          title: "Auto sync upstream/dev â†’ main"
          body: "Automated sync from upstream/dev."
          labels: "chore,auto-sync"
          # ä¸­æ–‡è¨»è§£ï¼šä¸è‡ªå‹•åˆªåˆ†æ”¯ï¼Œä¿ç•™çµ¦ä¸‹æ¬¡è¦†å¯«åŒååˆ†æ”¯ä½¿ç”¨
          delete-branch: false
          # ä¸­æ–‡è¨»è§£ï¼šæŠŠ PR æŒ‡åˆ° main
          base: main
