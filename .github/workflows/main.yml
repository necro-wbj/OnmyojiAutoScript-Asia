name: Auto Rebase Upstream Dev (quiet PR-only)

on:
  schedule:
    - cron: "*/5 * * * *"   # æœ€å°é–“éš” 5 åˆ†é˜
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths-ignore:
      - ".github/**"
      - "docs/**"
      - "README.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream:
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # æŠ“å…¨æ­·å²ï¼Œé¿å…æ¯”è¼ƒä¸æº–ç¢º
      - name: Git setup
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config core.autocrlf false

      - name: Add upstream & fetch all
        run: |
          set -euo pipefail
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/runhey/OnmyojiAutoScript.git
          git fetch --prune origin +refs/heads/*:refs/remotes/origin/*
          git fetch --prune upstream +refs/heads/*:refs/remotes/upstream/*

      # è§£æä¾†æº & å¿«é€Ÿæª¢æŸ¥ tip æ˜¯å¦è®Šå‹•ï¼ˆåƒ…ç”¨æ–¼æ—©é€€ï¼Œä¸å« pathspecï¼‰
      - name: Resolve upstream ref & tip-diff
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          TARGET_BRANCH="dev"
          if git ls-remote --heads upstream "$TARGET_BRANCH" | grep -q "refs/heads/$TARGET_BRANCH"; then
            UP_REF="upstream/${TARGET_BRANCH}"
            REASON="found-branch"
          else
            UP_REF="origin/main"
            REASON="fallback-origin-main"
          fi
          UP_TIP=$(git rev-parse --short "${UP_REF}")
          ORI_TIP=$(git rev-parse --short origin/main)
          read BEHIND AHEAD < <(git rev-list --left-right --count origin/main..."${UP_REF}" | awk '{print $1" "$2}')

          {
            echo "up_ref=${UP_REF}"
            echo "reason=${REASON}"
            echo "upstream_tip=${UP_TIP}"
            echo "origin_tip=${ORI_TIP}"
            echo "ahead=${AHEAD}"
            echo "behind=${BEHIND}"
          } >> "$GITHUB_OUTPUT"

          echo "[LOG] ${REASON}  up_ref=${UP_REF}  up_tip=${UP_TIP}  base_tip=${ORI_TIP}"
          echo "[LOG] rev-list(origin/main...${UP_REF}) BEHIND=${BEHIND} AHEAD=${AHEAD}"

      # æ—©é€€ 1ï¼štips å®Œå…¨ç›¸åŒ â†’ ä¸åšäº‹
      - name: Early exit if tips identical
        if: steps.resolve.outputs.ahead == '0' && steps.resolve.outputs.behind == '0'
        run: echo "[LOG] Tips identical; skip run."

      # å–å¾—æ—¢æœ‰ PR åˆ†æ”¯ï¼ˆè‹¥æœ‰ï¼‰ï¼Œè®€å–ä¸Šæ¬¡è¨˜éŒ„çš„ upstream tip
      - name: Fetch existing PR branch (if any)
        if: steps.resolve.outputs.ahead != '0' || steps.resolve.outputs.behind != '0'
        id: prev
        shell: bash
        run: |
          set -euo pipefail
          git fetch --prune origin refs/heads/sync/upstream-dev:refs/remotes/origin/sync/upstream-dev || true
          PREV_TIP=""
          if git show origin/sync/upstream-dev:.sync/upstream-tip.txt >/dev/null 2>&1; then
            PREV_TIP=$(git show origin/sync/upstream-dev:.sync/upstream-tip.txt | sed -n 's/^upstream_tip=//p' | head -n1)
          fi
          echo "prev_tip=${PREV_TIP}" >> "$GITHUB_OUTPUT"
          echo "[LOG] previous recorded upstream_tip: ${PREV_TIP:-<none>}"

      # Materializeï¼šå…ˆæŠŠ upstream å±•é–‹åˆ° staging åˆ†æ”¯ï¼Œå†æ’é™¤ .github èˆ‡å›ºå®šæœ¬åœ°æª”
      - name: Materialize upstream into staging
        if: steps.resolve.outputs.ahead != '0' || steps.resolve.outputs.behind != '0'
        shell: bash
        run: |
          set -euo pipefail
          UP_REF="${{ steps.resolve.outputs.up_ref }}"
          git switch -c sync-staging origin/main
          git rm -r -q --cached . || true
          git clean -fdqx || true
          git archive --format=tar "${UP_REF}" | tar -x -m --exclude=".github" --exclude="./.github"
          git checkout origin/main -- .gitattributes .gitignore README.md || true
          rm -rf .github || true
          git checkout origin/main -- .github || true
          git add --renormalize -A
          echo "[LOG] Staged diff (excluding .github):"
          git --no-pager diff --cached --stat || true

      # åˆ¤å®š materialize å¾Œæ˜¯å¦é‚„æœ‰ã€Œå¯¦è³ªå·®ç•°ã€
      - name: Is there real diff outside .github?
        id: diffcheck
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet origin/main..HEAD -- . ":(exclude).github" ":(exclude).github/**"; then
            echo "real_diff=false" >> "$GITHUB_OUTPUT"
            echo "[LOG] No real diff outside .github after materialize."
          else
            echo "real_diff=true"  >> "$GITHUB_OUTPUT"
            echo "[LOG] Real diff detected outside .github."
          fi

      # åƒ…ç•¶ã€Œæ²’æœ‰å¯¦è³ªå·®ç•°ã€ä½† upstream tip è®Šäº†ä¸”æœªæ›¾è¨˜éŒ„é â†’ å¯« .sync è¨˜éŒ„ï¼Œé¿å…é‡è¤‡æ›´æ–°
      - name: Write .sync meta only when needed (avoid churn)
        if: steps.diffcheck.outputs.real_diff == 'false'
        shell: bash
        run: |
          set -euo pipefail
          CUR="${{ steps.resolve.outputs.upstream_tip }}"
          PREV="${{ steps.prev.outputs.prev_tip }}"
          if [ "${CUR}" != "${PREV}" ] && [ -n "${CUR}" ]; then
            mkdir -p .sync
            {
              echo "up_ref=${{ steps.resolve.outputs.up_ref }}"
              echo "upstream_tip=${CUR}"
              echo "origin_tip=${{ steps.resolve.outputs.origin_tip }}"
              echo "generated_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            } > .sync/upstream-tip.txt
            git add .sync/upstream-tip.txt
            echo "[LOG] Wrote .sync/upstream-tip.txt (new upstream tip)."
          else
            echo "[LOG] Same upstream tip as existing PR branch; skip meta write."
          fi

      # æœ€çµ‚å†çœ‹ä¸€æ¬¡æ˜¯å¦æœ‰å·®ç•°ï¼ˆå« .sync æª”çš„å¯èƒ½æ–°å¢ï¼‰
      - name: Final diff gate (will we PR?)
        id: finalgate
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet origin/main..HEAD ; then
            echo "will_pr=false" >> "$GITHUB_OUTPUT"
            echo "[LOG] Nothing to PR."
          else
            echo "will_pr=true"  >> "$GITHUB_OUTPUT"
            echo "[LOG] We will create/update PR."
          fi

      - name: Create / Update PR (quiet)
        if: steps.finalgate.outputs.will_pr == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: sync/upstream-dev      # å›ºå®šåˆ†æ”¯ â†’ åŒä¸€å€‹ PR æœƒè¢«æ›´æ–°ï¼Œä¸æœƒé–‹å¾ˆå¤šå€‹
          base: main
          title: "Auto sync ${{ steps.resolve.outputs.up_ref }} â†’ main (tip=${{ steps.resolve.outputs.upstream_tip }})"
          commit-message: "chore(sync): ${{ steps.resolve.outputs.up_ref }}@${{ steps.resolve.outputs.upstream_tip }}"
          body: |
            Automated sync from **${{ steps.resolve.outputs.up_ref }}** to **main** (quiet mode).
            - reason: `${{ steps.resolve.outputs.reason }}`
            - upstream tip: `${{ steps.resolve.outputs.upstream_tip }}`
            - origin tip:   `${{ steps.resolve.outputs.origin_tip }}`
            - ahead:  `${{ steps.resolve.outputs.ahead }}`
            - behind: `${{ steps.resolve.outputs.behind }}`
            - note: PR updates only when upstream tip changes or real diff exists.
          labels: "chore,auto-sync"
          draft: true             # â† æ¸›å°‘é€šçŸ¥ï¼ˆå¯æ”¹æˆ falseï¼‰
          delete-branch: false
          # é è¨­è¡Œç‚ºï¼šæœƒæŒçºŒæ›´æ–°æ—¢æœ‰ PRï¼Œè€Œä¸æ˜¯æ¯æ¬¡é–‹æ–° PRã€‚:contentReference[oaicite:3]{index=3}

      - name: Notify Discord (only on actual CPR operation)
        if: steps.cpr.outputs.pull-request-operation && steps.cpr.outputs.pull-request-operation != 'none'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          OP: ${{ steps.cpr.outputs.pull-request-operation }}
        run: |
          set -euo pipefail
          MSG=$(cat <<EOF
          ğŸ”„ **Auto sync ${{ steps.resolve.outputs.up_ref }} â†’ main** (${OP})
          PR: ${PR_URL}
          EOF
          )
          curl -sS -X POST "$DISCORD_WEBHOOK" \
          curl -sS -X POST "$DISCORD_WEBHOOK" -H 'Content-Type: application/json' \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg content "$MSG" '{content: $content}')"
      - name: Notify Discord (run failed)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          MSG=$(cat <<EOF
          âŒ **Auto sync failed**
          Run: ${RUN_URL}
          EOF
          )
          curl -sS -X POST "$DISCORD_WEBHOOK" \
            -H 'Content-Type: application/json' \
             -d "$(jq -n --arg content "$MSG" '{content: $content}')"
